{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/YoussefElFhayel/OneDrive%20-%20Akumenia/Bureau/ramlive/app/api/prayer-times/route.js"],"sourcesContent":["import { Redis } from '@upstash/redis';\r\n\r\n// ========================================\r\n// WARMED REDIS CLIENT - Outside handler\r\n// ========================================\r\nconst redis = new Redis({\r\n    url: 'https://keen-weevil-41108.upstash.io',\r\n    token: 'AaCUAAIncDIxN2I5MGVmYzcyZDg0YzEwOGM3Y2I1OWQxYjlkMzhmNnAyNDExMDg',\r\n});\r\n\r\n// Constants\r\nconst CACHE_TTL = 3024000; // 35 days\r\nconst LOCK_TTL = 10;\r\nconst RETRY_ATTEMPTS = 5;\r\nconst RETRY_DELAY = 200;\r\n\r\n// ========================================\r\n// HELPERS - Pure functions for speed\r\n// ========================================\r\nconst normalize = (str) => str?.trim().toLowerCase().replace(/\\s+/g, '-') || '';\r\n\r\nconst getCurrentMonth = () => {\r\n    const d = new Date();\r\n    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;\r\n};\r\n\r\nconst sleep = (ms) => new Promise(r => setTimeout(r, ms));\r\n\r\nconst fetchAlAdhan = async (city, country, method, month, year) => {\r\n    const url = `https://api.aladhan.com/v1/calendarByCity/${year}/${month}?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=${method}`;\r\n    const res = await fetch(url, {\r\n        headers: { 'Accept': 'application/json', 'User-Agent': 'RamadanCompanion/1.0' },\r\n    });\r\n    if (!res.ok) throw new Error(`AlAdhan: ${res.status}`);\r\n    const json = await res.json();\r\n    if (json.code !== 200 || !json.data) throw new Error(json.status || 'City not found');\r\n    return json.data;\r\n};\r\n\r\n// ========================================\r\n// MAIN HANDLER - Data First Logic\r\n// ========================================\r\nexport async function GET(request) {\r\n    const { searchParams } = new URL(request.url);\r\n    const city = searchParams.get('city');\r\n    const country = searchParams.get('country') || '';\r\n    const method = searchParams.get('method') || '2';\r\n\r\n    // Validate\r\n    if (!city) {\r\n        return Response.json({ error: 'Missing: city' }, { status: 400 });\r\n    }\r\n\r\n    // Build cache key\r\n    const month = getCurrentMonth();\r\n    const [year, mon] = month.split('-');\r\n    const cacheKey = `prayer:v1:${normalize(country)}:${normalize(city)}:${month}:${method}`;\r\n\r\n    try {\r\n        // ========================================\r\n        // 1. IMMEDIATE GET - Data First!\r\n        // ========================================\r\n        const cached = await redis.get(cacheKey);\r\n        if (cached) {\r\n            // INSTANT RETURN - No other logic\r\n            return Response.json({ data: cached, source: 'cache', month });\r\n        }\r\n\r\n        // ========================================\r\n        // 2. LAZY LOCK - Only on cache miss\r\n        // ========================================\r\n        const lockKey = `lock:${cacheKey}`;\r\n        const lockAcquired = await redis.set(lockKey, '1', { nx: true, ex: LOCK_TTL });\r\n\r\n        if (!lockAcquired) {\r\n            // Another request is fetching, wait for cache\r\n            for (let i = 0; i < RETRY_ATTEMPTS; i++) {\r\n                await sleep(RETRY_DELAY);\r\n                const retryData = await redis.get(cacheKey);\r\n                if (retryData) {\r\n                    return Response.json({ data: retryData, source: 'cache', month });\r\n                }\r\n            }\r\n            return Response.json({ error: 'Service busy, please retry' }, { status: 503 });\r\n        }\r\n\r\n        // ========================================\r\n        // 3. FETCH & CACHE - Raw JSON, no processing\r\n        // ========================================\r\n        const data = await fetchAlAdhan(city, country, method, mon, year);\r\n\r\n        // Fire-and-forget cache set (don't await)\r\n        redis.set(cacheKey, data, { ex: CACHE_TTL }).catch(() => { });\r\n\r\n        return Response.json({ data, source: 'api', month });\r\n\r\n    } catch (err) {\r\n        // ========================================\r\n        // FAIL OPEN - Direct fetch if Redis down\r\n        // ========================================\r\n        if (err.message?.includes('Redis') || err.message?.includes('ECONN')) {\r\n            try {\r\n                const data = await fetchAlAdhan(city, country, method, mon, year);\r\n                return Response.json({ data, source: 'direct', month });\r\n            } catch (e) {\r\n                return Response.json({ error: e.message }, { status: 502 });\r\n            }\r\n        }\r\n        return Response.json({ error: err.message }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}