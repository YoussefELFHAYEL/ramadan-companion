{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/YoussefElFhayel/OneDrive%20-%20Akumenia/Bureau/ramlive/app/api/daily-ayah/route.js"],"sourcesContent":["import { Redis } from '@upstash/redis';\r\n\r\n// ========================================\r\n// WARMED REDIS CLIENT\r\n// ========================================\r\nconst redis = new Redis({\r\n    url: 'https://keen-weevil-41108.upstash.io',\r\n    token: 'AaCUAAIncDIxN2I5MGVmYzcyZDg0YzEwOGM3Y2I1OWQxYjlkMzhmNnAyNDExMDg',\r\n});\r\n\r\n// Constants\r\nconst TOTAL_AYAHS = 6236;\r\nconst CACHE_TTL = 86400; // 24 hours\r\n\r\n// ========================================\r\n// HELPERS\r\n// ========================================\r\nconst getTodayKey = () => {\r\n    const d = new Date();\r\n    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;\r\n};\r\n\r\n// Deterministic \"random\" based on date - same verse all day for everyone\r\nconst getAyahIdForDate = (dateStr) => {\r\n    let hash = 0;\r\n    for (let i = 0; i < dateStr.length; i++) {\r\n        hash = ((hash << 5) - hash) + dateStr.charCodeAt(i);\r\n        hash = hash & hash;\r\n    }\r\n    return (Math.abs(hash) % TOTAL_AYAHS) + 1;\r\n};\r\n\r\nconst fetchAyah = async (ayahId) => {\r\n    const url = `https://api.alquran.cloud/v1/ayah/${ayahId}/editions/quran-uthmani,en.asad,ar.alafasy`;\r\n\r\n    const res = await fetch(url);\r\n    if (!res.ok) throw new Error(`AlQuran API: ${res.status}`);\r\n\r\n    const json = await res.json();\r\n    if (json.code !== 200 || !json.data) throw new Error('Invalid response');\r\n\r\n    const [arabic, english, audio] = json.data;\r\n\r\n    return {\r\n        number: ayahId,\r\n        arabic: arabic.text,\r\n        translation: english.text,\r\n        audioUrl: audio.audio,\r\n        surah: {\r\n            number: arabic.surah.number,\r\n            name: arabic.surah.name,\r\n            englishName: arabic.surah.englishName,\r\n            englishNameTranslation: arabic.surah.englishNameTranslation,\r\n        },\r\n        numberInSurah: arabic.numberInSurah,\r\n        juz: arabic.juz,\r\n    };\r\n};\r\n\r\n// ========================================\r\n// API HANDLER\r\n// ========================================\r\nexport async function GET() {\r\n    const today = getTodayKey();\r\n    const cacheKey = `ayah:daily:${today}`;\r\n\r\n    try {\r\n        // ========================================\r\n        // 1. INSTANT REDIS CHECK\r\n        // ========================================\r\n        const cached = await redis.get(cacheKey);\r\n        if (cached) {\r\n            return Response.json({ ayah: cached, source: 'cache', date: today });\r\n        }\r\n\r\n        // ========================================\r\n        // 2. FETCH FROM AL QURAN CLOUD\r\n        // ========================================\r\n        const ayahId = getAyahIdForDate(today);\r\n        const ayah = await fetchAyah(ayahId);\r\n\r\n        // ========================================\r\n        // 3. CACHE FOR 24 HOURS\r\n        // ========================================\r\n        redis.set(cacheKey, ayah, { ex: CACHE_TTL }).catch(() => { });\r\n\r\n        return Response.json({ ayah, source: 'api', date: today });\r\n\r\n    } catch (err) {\r\n        console.error('Daily Ayah error:', err);\r\n        return Response.json({ error: err.message }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,2CAA2C;AAC3C,sBAAsB;AACtB,2CAA2C;AAC3C,MAAM,QAAQ,IAAI,yNAAK,CAAC;IACpB,KAAK;IACL,OAAO;AACX;AAEA,YAAY;AACZ,MAAM,cAAc;AACpB,MAAM,YAAY,OAAO,WAAW;AAEpC,2CAA2C;AAC3C,UAAU;AACV,2CAA2C;AAC3C,MAAM,cAAc;IAChB,MAAM,IAAI,IAAI;IACd,OAAO,GAAG,EAAE,WAAW,GAAG,CAAC,EAAE,OAAO,EAAE,QAAQ,KAAK,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,OAAO,EAAE,OAAO,IAAI,QAAQ,CAAC,GAAG,MAAM;AACpH;AAEA,yEAAyE;AACzE,MAAM,mBAAmB,CAAC;IACtB,IAAI,OAAO;IACX,IAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,MAAM,EAAE,IAAK;QACrC,OAAO,AAAC,CAAC,QAAQ,CAAC,IAAI,OAAQ,QAAQ,UAAU,CAAC;QACjD,OAAO,OAAO;IAClB;IACA,OAAO,AAAC,KAAK,GAAG,CAAC,QAAQ,cAAe;AAC5C;AAEA,MAAM,YAAY,OAAO;IACrB,MAAM,MAAM,CAAC,kCAAkC,EAAE,OAAO,0CAA0C,CAAC;IAEnG,MAAM,MAAM,MAAM,MAAM;IACxB,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,aAAa,EAAE,IAAI,MAAM,EAAE;IAEzD,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,IAAI,KAAK,IAAI,KAAK,OAAO,CAAC,KAAK,IAAI,EAAE,MAAM,IAAI,MAAM;IAErD,MAAM,CAAC,QAAQ,SAAS,MAAM,GAAG,KAAK,IAAI;IAE1C,OAAO;QACH,QAAQ;QACR,QAAQ,OAAO,IAAI;QACnB,aAAa,QAAQ,IAAI;QACzB,UAAU,MAAM,KAAK;QACrB,OAAO;YACH,QAAQ,OAAO,KAAK,CAAC,MAAM;YAC3B,MAAM,OAAO,KAAK,CAAC,IAAI;YACvB,aAAa,OAAO,KAAK,CAAC,WAAW;YACrC,wBAAwB,OAAO,KAAK,CAAC,sBAAsB;QAC/D;QACA,eAAe,OAAO,aAAa;QACnC,KAAK,OAAO,GAAG;IACnB;AACJ;AAKO,eAAe;IAClB,MAAM,QAAQ;IACd,MAAM,WAAW,CAAC,WAAW,EAAE,OAAO;IAEtC,IAAI;QACA,2CAA2C;QAC3C,yBAAyB;QACzB,2CAA2C;QAC3C,MAAM,SAAS,MAAM,MAAM,GAAG,CAAC;QAC/B,IAAI,QAAQ;YACR,OAAO,SAAS,IAAI,CAAC;gBAAE,MAAM;gBAAQ,QAAQ;gBAAS,MAAM;YAAM;QACtE;QAEA,2CAA2C;QAC3C,+BAA+B;QAC/B,2CAA2C;QAC3C,MAAM,SAAS,iBAAiB;QAChC,MAAM,OAAO,MAAM,UAAU;QAE7B,2CAA2C;QAC3C,wBAAwB;QACxB,2CAA2C;QAC3C,MAAM,GAAG,CAAC,UAAU,MAAM;YAAE,IAAI;QAAU,GAAG,KAAK,CAAC,KAAQ;QAE3D,OAAO,SAAS,IAAI,CAAC;YAAE;YAAM,QAAQ;YAAO,MAAM;QAAM;IAE5D,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,SAAS,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IAC/D;AACJ"}}]
}