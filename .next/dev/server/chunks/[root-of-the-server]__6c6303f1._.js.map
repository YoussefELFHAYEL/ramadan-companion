{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/YoussefElFhayel/OneDrive%20-%20Akumenia/Bureau/ramlive/app/api/suggestions/route.js"],"sourcesContent":["import { Redis } from '@upstash/redis';\r\n\r\n// ========================================\r\n// WARMED REDIS CLIENT\r\n// ========================================\r\nconst redis = new Redis({\r\n    url: 'https://keen-weevil-41108.upstash.io',\r\n    token: 'AaCUAAIncDIxN2I5MGVmYzcyZDg0YzEwOGM3Y2I1OWQxYjlkMzhmNnAyNDExMDg',\r\n});\r\n\r\n// Constants\r\nconst GEOAPIFY_KEY = '4ca724da292c40f58f458b6e72233724'; // ONLY used server-side!\r\nconst CACHE_TTL = 7776000; // 90 days in seconds\r\n\r\n// ========================================\r\n// HELPERS\r\n// ========================================\r\n// Use ONLY first 3 characters for maximum efficiency\r\nconst normalizePrefix = (q) => q?.toLowerCase().trim().substring(0, 3) || '';\r\n\r\nconst fetchGeoapify = async (query) => {\r\n    const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&type=city&format=json&apiKey=${GEOAPIFY_KEY}`;\r\n\r\n    const res = await fetch(url);\r\n    if (!res.ok) return [];\r\n\r\n    const data = await res.json();\r\n\r\n    // Extract and simplify results - return more results for local filtering\r\n    return (data.results || []).slice(0, 20).map(item => ({\r\n        city: item.city || item.name || '',\r\n        country: item.country || '',\r\n        formatted: item.formatted || `${item.city}, ${item.country}`,\r\n    })).filter(item => item.city);\r\n};\r\n\r\n// ========================================\r\n// API HANDLER\r\n// ========================================\r\nexport async function GET(request) {\r\n    const { searchParams } = new URL(request.url);\r\n    const q = searchParams.get('q');\r\n\r\n    if (!q || q.length < 3) {\r\n        return Response.json({ results: [], prefix: '' });\r\n    }\r\n\r\n    // Only use first 3 characters for cache key\r\n    const prefix = normalizePrefix(q);\r\n    const cacheKey = `suggestions:${prefix}`;\r\n\r\n    try {\r\n        // ========================================\r\n        // 1. INSTANT REDIS CHECK\r\n        // ========================================\r\n        const cached = await redis.get(cacheKey);\r\n        if (cached) {\r\n            return Response.json({ results: cached, prefix, source: 'cache' });\r\n        }\r\n\r\n        // ========================================\r\n        // 2. FETCH FROM GEOAPIFY (using full query for better results)\r\n        // ========================================\r\n        const results = await fetchGeoapify(q);\r\n\r\n        // ========================================\r\n        // 3. CACHE RESULTS with 90-day TTL\r\n        // ========================================\r\n        if (results.length > 0) {\r\n            redis.set(cacheKey, results, { ex: CACHE_TTL }).catch(() => { });\r\n        }\r\n\r\n        return Response.json({ results, prefix, source: 'api' });\r\n\r\n    } catch (err) {\r\n        console.error('Suggestions API error:', err);\r\n        return Response.json({ results: [], prefix });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,2CAA2C;AAC3C,sBAAsB;AACtB,2CAA2C;AAC3C,MAAM,QAAQ,IAAI,yNAAK,CAAC;IACpB,KAAK;IACL,OAAO;AACX;AAEA,YAAY;AACZ,MAAM,eAAe,oCAAoC,yBAAyB;AAClF,MAAM,YAAY,SAAS,qBAAqB;AAEhD,2CAA2C;AAC3C,UAAU;AACV,2CAA2C;AAC3C,qDAAqD;AACrD,MAAM,kBAAkB,CAAC,IAAM,GAAG,cAAc,OAAO,UAAU,GAAG,MAAM;AAE1E,MAAM,gBAAgB,OAAO;IACzB,MAAM,MAAM,CAAC,sDAAsD,EAAE,mBAAmB,OAAO,8BAA8B,EAAE,cAAc;IAE7I,MAAM,MAAM,MAAM,MAAM;IACxB,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO,EAAE;IAEtB,MAAM,OAAO,MAAM,IAAI,IAAI;IAE3B,yEAAyE;IACzE,OAAO,CAAC,KAAK,OAAO,IAAI,EAAE,EAAE,KAAK,CAAC,GAAG,IAAI,GAAG,CAAC,CAAA,OAAQ,CAAC;YAClD,MAAM,KAAK,IAAI,IAAI,KAAK,IAAI,IAAI;YAChC,SAAS,KAAK,OAAO,IAAI;YACzB,WAAW,KAAK,SAAS,IAAI,GAAG,KAAK,IAAI,CAAC,EAAE,EAAE,KAAK,OAAO,EAAE;QAChE,CAAC,GAAG,MAAM,CAAC,CAAA,OAAQ,KAAK,IAAI;AAChC;AAKO,eAAe,IAAI,OAAO;IAC7B,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,IAAI,aAAa,GAAG,CAAC;IAE3B,IAAI,CAAC,KAAK,EAAE,MAAM,GAAG,GAAG;QACpB,OAAO,SAAS,IAAI,CAAC;YAAE,SAAS,EAAE;YAAE,QAAQ;QAAG;IACnD;IAEA,4CAA4C;IAC5C,MAAM,SAAS,gBAAgB;IAC/B,MAAM,WAAW,CAAC,YAAY,EAAE,QAAQ;IAExC,IAAI;QACA,2CAA2C;QAC3C,yBAAyB;QACzB,2CAA2C;QAC3C,MAAM,SAAS,MAAM,MAAM,GAAG,CAAC;QAC/B,IAAI,QAAQ;YACR,OAAO,SAAS,IAAI,CAAC;gBAAE,SAAS;gBAAQ;gBAAQ,QAAQ;YAAQ;QACpE;QAEA,2CAA2C;QAC3C,+DAA+D;QAC/D,2CAA2C;QAC3C,MAAM,UAAU,MAAM,cAAc;QAEpC,2CAA2C;QAC3C,mCAAmC;QACnC,2CAA2C;QAC3C,IAAI,QAAQ,MAAM,GAAG,GAAG;YACpB,MAAM,GAAG,CAAC,UAAU,SAAS;gBAAE,IAAI;YAAU,GAAG,KAAK,CAAC,KAAQ;QAClE;QAEA,OAAO,SAAS,IAAI,CAAC;YAAE;YAAS;YAAQ,QAAQ;QAAM;IAE1D,EAAE,OAAO,KAAK;QACV,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,SAAS,IAAI,CAAC;YAAE,SAAS,EAAE;YAAE;QAAO;IAC/C;AACJ"}}]
}